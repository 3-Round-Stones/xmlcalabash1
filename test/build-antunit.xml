<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="CalabashTask-antunit"
	 basedir="."
	 default="antunit"
	 xmlns:au="antlib:org.apache.ant.antunit">

  <dirname property="test.basedir" file="${ant.file.CalabashTask-antunit}"/>

  <property name="antunit.home" value="/usr/local/src/apache-ant-antunit-1.2"/>

  <taskdef 
      uri="antlib:org.apache.ant.antunit"
      resource="org/apache/ant/antunit/antlib.xml">
    <classpath>
      <pathelement location="${antunit.home}/ant-antunit-1.2.jar"/>
    </classpath>
  </taskdef>

  <taskdef name="calabash"
	   classname="com.xmlcalabash.drivers.CalabashTask"
	   classpath="${test.basedir}/../calabash.jar"/>

  <target name="antunit">
    <au:antunit>
      <file file="build-antunit.xml"/>
      <au:plainlistener/>
    </au:antunit>
  </target>

  <mkdir dir="out" />

  <target name="testBasic" description="Use without 'in', 'out', and 'pipeline'.">
    <calabash in="in.xml" out="out1.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
    </calabash>
  </target>

  <target name="testIn2" description="Use with different input.">
    <calabash in="in2.xml" out="out2.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
    </calabash>
  </target>

  <target name="testInport" description="Use with bogus 'inport'.">
    <au:expectfailure expectedmessage="0 documents appear on the 'source' port.">
      <calabash in="in.xml" out="out3.xml" inport="bogus" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testInport2" description="Use with real 'inport' value.">
    <calabash in="in.xml" inport="source" out="out4.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
    </calabash>
  </target>

  <target name="testOutport" description="Use with bogus 'outport'.">
    <calabash in="in.xml" out="out5.xml" outport="bogus" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
    </calabash>
  </target>

  <target name="testOutport2" description="Use with real 'outport' value.">
    <calabash in="in.xml" out="out6.xml" outport="result" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
    </calabash>
  </target>

  <target name="testNestedPipeline" description="Use with nested 'pipeline'">
    <calabash in="in.xml" out="out7.xml">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <pipeline>
	<file file="pipeline.xpl" />
      </pipeline>
    </calabash>
  </target>

  <target name="TestMultiport1" description="Use with multiple input ports.">
    <calabash in="doc.xml" out="out8.xml" pipeline="compare-001.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <input port="alternate">
	<file file="doc.xml" />
      </input>
    </calabash>
  </target>

  <target name="testOutport3" description="Use with real 'outport' value.">
    <calabash in="in.xml" outport="result" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <output>
	<file file="out9.xml" />
      </output>
    </calabash>
  </target>

  <target name="testOutport4" description="Use with real 'outport' value.">
    <calabash in="in.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <output port="result">
	<file file="out10.xml" />
      </output>
    </calabash>
  </target>

  <target name="testNestedInput1" description="Use with nested input port.">
    <calabash out="out11.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <input port="source">
	<file file="in.xml" />
      </input>
    </calabash>
  </target>

  <target name="testNestedInput2" description="Use with nested input port.">
    <calabash out="out12.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <input>
	<file file="in.xml" />
      </input>
    </calabash>
  </target>

  <target name="testMultiport2" description="Use with multiple input ports.">
    <calabash out="out13.xml" pipeline="compare-001.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <input port="source">
	<file file="doc.xml" />
      </input>
      <input port="alternate">
	<file file="doc.xml" />
      </input>
    </calabash>
  </target>

  <target name="testIncludes1" description="Use with 'includes' value.">
    <calabash includes="in.xml" outport="result" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
      <output>
	<file file="out14.xml" />
      </output>
    </calabash>
  </target>

  <target name="testIncludes2" description="Use with 'includes' value.">
    <calabash includes="in*.xml" destdir="out" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
    </calabash>
  </target>


  <target name="testIncludes3" description="Use with 'includes' and 'basedir' values.">
    <calabash includes="in*.xml" basedir="in" destdir="out" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false"/>
    </calabash>
  </target>

  <target name="testBinding1" description="Use with 'includes' and 'basedir' values.">
    <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
      <namespace prefix="hi" uri="there" />
    </calabash>
  </target>

  <target name="testBinding2" description="Namespace prefix but no URI">
    <au:expectfailure expectedmessage="&lt;namespace> URI cannot be null">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace prefix="hi" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testBinding3" description="Use with 'includes' and 'basedir' values.">
    <au:expectfailure expectedmessage="&lt;namespace> prefix cannot be null">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace uri="there" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testBinding4" description="No prefix, no URI.">
    <au:expectfailure expectedmessage="cannot be null">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testBinding5" description="Duplicated namespace prefix.">
    <au:expectfailure expectedmessage="Duplicated &lt;namespace> prefix">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace prefix="hi" uri="there" />
	<namespace prefix="hi" uri="not there" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testParameter1" description="Bound prefix.">
    <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
      <namespace prefix="hi" uri="there" />
      <parameter name="hi:there" value="a value" />
    </calabash>
  </target>

  <target name="testParameter2" description="Use with 'includes' and 'basedir' values.">
    <au:expectfailure expectedmessage="Unbound prefix">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace prefix="hi" uri="there" />
	<parameter name="not:there" value="a value" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testParameter3" description="Duplicated parameter QName.">
    <au:expectfailure expectedmessage="Duplicated parameter QName">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace prefix="hi" uri="there" />
	<parameter name="hi:there" value="a value" />
	<parameter name="hi:there" value="another value" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testParameter4" description="Duplicated parameter QName: same URI, different prefixes.">
    <au:expectfailure expectedmessage="Duplicated parameter QName">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace prefix="hi" uri="there" />
	<namespace prefix="not" uri="there" />
	<parameter name="hi:there" value="a value" />
	<parameter name="not:there" value="another value" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testParameter5"
	  description="'p' prefix should be bound automatically but is an error to use it for parameters.  Should fail with 'XD0031'.">
    <au:expectfailure expectedmessage="XD0031">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<parameter name="p:there" value="in your morning" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testParameter6" description="Empty parameter name.">
    <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
      <parameter name="" value="a value" />
    </calabash>
  </target>

  <target name="testParameter7" description="No-namespace parameter name.">
    <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
      <parameter name="no-namespace" value="a value" />
    </calabash>
  </target>

  <target name="testParameter8" description="Clack notation in parameter name.">
    <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
      <namespace prefix="hi" uri="low" />
      <parameter name="{hi}there" value="a value" />
      <parameter name="hi:there" value="a value" />
    </calabash>
  </target>

  <target name="testParameter9" description="Clack notation in duplicate parameter names.">
    <au:expectfailure expectedmessage="Duplicated parameter QName">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<parameter name="{hi}there" value="a value" />
	<parameter name="{hi}there" value="another value" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testParameter10" description="Duplicate QName in bound and Clack notation parameter names.">
    <au:expectfailure expectedmessage="Duplicated parameter QName">
      <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
	<sysproperty key="com.xmlcalabash.phonehome" value="false" />
	<namespace prefix="hi" uri="low" />
	<parameter name="{low}there" value="a value" />
	<parameter name="hi:there" value="a value" />
      </calabash>
    </au:expectfailure>
  </target>

  <target name="testOption1" description="Valid no-namespace option.">
    <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
      <option name="no-namespace" value="a value" />
    </calabash>
  </target>

  <target name="testOption2" description="'p' prefix should be bound automatically.">
    <calabash in="in.xml" out="out.xml" pipeline="pipeline.xpl">
      <sysproperty key="com.xmlcalabash.phonehome" value="false" />
      <option name="p:there" value="in your night" />
    </calabash>
  </target>

</project>
